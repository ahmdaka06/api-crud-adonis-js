!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n.indicative=n.indicative||{},n.indicative.validator=e())}(this,function(){"use strict";function n(n,e){if(!function(n){return null!==n&&"object"==typeof n}(n)||"string"!=typeof e)return n;for(var r=e.split("."),t=0;t<r.length;t++){var i=r[t];if(null===(n=n.hasOwnProperty(i)?n[i]:null))break}return n}function e(n){this.fn=n,this._promise=null}e.prototype.then=function(n,e){return this._promise=this._promise||new Promise(this.fn),this._promise.then(n,e)},e.prototype.catch=function(n){return this._promise=this._promise||new Promise(this.fn),this._promise.catch(n)};var r=function(n,e){e.add();for(var r=n.length,t=0,i="name";t<r;){var o=n[t++],u=o.charCodeAt(0);58===u||44===u?(i="arg",e.shiftValue()):124===u?(i="name",e.add()):"arg"===i?e.appendValue(o):e.appendKey(o,u)}return e.toJSON()};var t=function(){return{nodes:[],currentNode:null,add:function(){this.currentNode={name:"",args:[]},this.nodes.push(this.currentNode)},appendKey:function(n,e){32!==e&&(this.currentNode.name+=n)},appendValue:function(n){this.currentNode.args[this.currentNode.args.length-1]+=n},shiftValue:function(){this.currentNode.args.push("")},toJSON:function(){return this.nodes}}};function i(e,i){return i=i||{},Object.keys(e).reduce(function(o,u){var a=e[u];if("string"==typeof a)a=r(a,new t);else if(!Array.isArray(a))throw new Error("Rules must be defined as a string or an array");u.indexOf("*")>-1?function e(r,t,i,o){if(!t)return[];i=i||0;var u=r[i++],a=r[i];return o||(o=[u],u=""),o=o.reduce(function(e,r){var i=u?r+"."+u:r;if(void 0!==a){var o=n(t,i);if(Array.isArray(o))for(var f=o.length,s=0;s<f;s++)e.push(i+"."+s)}else e.push(i);return e},[]),i===r.length?o:e(r,t,i,o)}(u.split(/\.\*\.?/),i).forEach(function(n){o[n]=a}):o[u]=a;return o},{})}var o=function(n){return n.replace(/_(\w)/g,function(n,e){return e.toUpperCase()})};function u(e,r,t,i){var u=r.replace(/\.\d/g,".*"),a=o(t),f=e[u+"."+t]||e[u+"."+a]||e[t]||e[a]||"{{validation}} validation failed on {{ field }}";return"function"==typeof f?f(u,t,i):function(e,r,t){t=t||{skipUndefined:!1,throwOnUndefined:!1};for(var i,o=/{{2}(.+?)}{2}/g,u=e;null!==(i=o.exec(e));){var a=i[1].trim();if(a){var f=n(r,a);if(void 0!==f&&null!==f)u=u.replace(i[0],f);else{if(t.throwOnUndefined){var s=new Error("Missing value for "+i[0]);throw s.key=a,s.code="E_MISSING_KEY",s}t.skipUndefined||(u=u.replace(i[0],""))}}}return u}(f,{field:r,validation:t,argument:i})}function a(r,t,i,a,f){return Object.keys(t).reduce(function(s,c){return t[c].map(function(t){s.push(function(r,t,i,a,f,s){var c=t.name,d=t.args;return new e(function(e,t){var l=o(c),h=r[l];if("function"!=typeof h){var p=new Error(l+" is not defined as a validation rule");return s.addError(p,i,l,d),void t(p)}h(a,i,u(f,i,c,d),d,n).then(e).catch(function(n){s.addError(n,i,l,d),t(n)})})}(r,t,c,i,a,f))}),s},[])}function f(n,e,r,t,o,u){return new Promise(function(f,s){o=o||{};var c=i(t,r);(function(n,e){var r=[],t=n.length;return function e(i,o){return i>=t?Promise.resolve(r):n[i].then(function(n){return r.push(function(n){return{fullFilled:!0,rejected:!1,value:n,reason:null}}(n)),e(i+1,o)}).catch(function(n){return r.push(function(n){return{fullFilled:!1,rejected:!0,value:null,reason:n}}(n)),o?Promise.resolve(r):e(i+1,o)})}(0,e)})(a(n,c,r,o,u),e).then(function(n){var e=u.toJSON();if(e)return s(e);f(r)})})}return function(n,e){var r="Cannot instantiate validator without";if(!n)throw new Error(r+" validations");if(!e)throw new Error(r+" error formatter");return{validate:function(r,t,i,o){return o=new(o||e),f(n,!0,r,t,i,o)},validateAll:function(r,t,i,o){return o=new(o||e),f(n,!1,r,t,i,o)}}}});
